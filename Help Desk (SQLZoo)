Scenario:
A software company has been successful in selling its products to a number of customer organisations, and there is now a 
high demand for technical support. There is already a system in place for logging support calls taken over the telephone 
and assigning them to engineers, but it is based on a series of spreadsheets. With the growing volume of data, using the 
spreadsheet system is becoming slow, and there is a significant risk that errors will be made.

Q: There are three issues that include the words "index" and "Oracle". Find the call_date for each of them.

SELECT DATE_FORMAT(call_date, '%Y-%m-%d %H:%i:%s') AS call_date, call_ref 
FROM Issue
WHERE detail LIKE "%index%" AND detail LIKE "%Oracle%";

Q: Samantha Hall made three calls on 2017-08-14. Show the date and time for each.

SELECT DATE_FORMAT(i.call_date, '%Y-%m-%d %H:%i:%s') AS call_date, c.first_name, c.last_name
FROM Issue AS i
JOIN Caller AS c ON i.caller_id = c.caller_id
WHERE c.first_name LIKE "%Samantha%" AND c.last_name LIKE "%Hall%" AND i.call_date LIKE "2017-08-14%";

Q: There are 500 calls in the system (roughly). Write a query that shows the number that have each status.

SELECT status, COUNT(*) AS Volume
FROM Issue
GROUP BY status;

Q: Calls are not normally assigned to a manager but it does happen. How many calls have been assigned to staff who are at 
Manager Level?

SELECT COUNT(call_ref) AS mlcc
FROM Issue AS i
JOIN Staff AS s ON i.assigned_to = s.staff_code
WHERE level_code IN (SELECT level_code
                     FROM Level
                     WHERE manager IS NOT NULL);

Q: Show the manager for each shift. Your output should include the shift date and type; also the first and last name of 
the manager.

SELECT DATE_FORMAT(shift_date, '%Y-%m-%d') AS Shift_date, shift_type, first_name, last_name
FROM Shift
LEFT JOIN Staff ON Shift.manager = Staff.staff_code
ORDER BY shift_date, shift_type;

 Q: List the Company name and the number of calls for those companies with more than 18 calls.

SELECT company_name, COUNT(call_ref) AS cc
FROM Customer AS cust
JOIN Caller AS c ON cust.company_ref = c.company_ref
JOIN Issue AS i ON c.caller_id = i.caller_id
GROUP BY company_name
HAVING cc > 18;

Q: Find the callers who have never made a call. Show first name and last name.

SELECT first_name, last_name
FROM Caller AS c
LEFT JOIN Issue AS i ON c.caller_id = i.caller_id
WHERE call_ref IS NULL;

Q: For each shift show the number of staff assigned. Beware that some roles may be NULL and that the same person might 
have been assigned to multiple roles (The roles are 'Manager', 'Operator', 'Engineer1', 'Engineer2').

WITH staff_assigned_cte AS
(
SELECT DATE_FORMAT(shift_date, '%Y-%m-%d') AS shift_date, shift_type, manager AS worker FROM Shift
UNION 
SELECT shift_date, shift_type, operator FROM Shift
UNION 
SELECT shift_date, shift_type, engineer1 FROM Shift
UNION 
SELECT shift_date, shift_type, engineer2 FROM Shift
)
SELECT shift_date, shift_type, COUNT(worker) AS cw
FROM staff_assigned_cte
GROUP BY shift_date, shift_type
ORDER BY shift_date, shift_type;

Q: Caller 'Harry' claims that the operator who took his most recent call was abusive and insulting. Find out who took the 
call (full name) and when.

SELECT s.first_name, s.last_name, DATE_FORMAT(i.call_date, '%Y-%m-%d %H:%i:%s') AS call_date
FROM Issue AS i
JOIN Staff AS s ON i.taken_by = s.staff_code
JOIN Caller AS c ON i.caller_id = c.caller_id 
WHERE c.first_name LIKE "%Harry%"
ORDER BY call_date DESC
LIMIT 1;

Q: Show the manager and number of calls received for each hour of the day on 2017-08-12.

SELECT manager, DATE_FORMAT(call_date, '%Y-%m-%d %H') AS Hr, COUNT(call_ref) AS cc
FROM Shift
JOIN Staff ON Shift.operator = Staff.staff_code
JOIN Issue ON Staff.staff_code = Issue.taken_by
WHERE DATE_FORMAT(call_date, '%Y-%m-%d %H') LIKE "2017-08-12%"
GROUP BY manager, hr
ORDER BY Hr

Q: 80/20 rule. It is said that 80% of the calls are generated by 20% of the callers. Is this true? What percentage of 
calls are generated by the most active 20% of callers.

WITH active_20pc_cte AS 
(
SELECT c.caller_id, COUNT(call_ref) AS nc
FROM Caller AS c
LEFT JOIN Issue AS i ON c.caller_id = i.caller_id
GROUP BY c.caller_id
ORDER BY nc DESC
LIMIT 29
)
SELECT (SUM(nc) / (SELECT COUNT(call_ref) FROM Issue)) * 100 AS t20pc
FROM active_20pc_cte 

Q: Annoying customers. Customers who call in the last five minutes of a shift are annoying. Find the most active 
customer who has never been annoying.

SELECT company_name, COUNT(call_ref) AS abna
FROM Customer AS cust
JOIN Caller AS c ON cust.company_ref = c.company_ref
JOIN Issue AS i ON c.caller_id = i.caller_id
WHERE i.caller_id NOT IN 
(
SELECT i.caller_id
FROM Issue AS i
JOIN Staff AS s ON i.taken_by = s.staff_code
JOIN Shift AS sh ON s.staff_code = sh.operator
JOIN Shift_type AS st ON sh.shift_type = st.shift_type
WHERE STR_TO_DATE(DATE_FORMAT(i.call_date, '%H:%i'), '%H:%i')
      BETWEEN DATE_SUB(STR_TO_DATE(st.end_time, '%H:%i'), INTERVAL 5 MINUTE)
          AND STR_TO_DATE(st.end_time, '%H:%i')
)
GROUP BY company_name
ORDER BY abna DESC
LIMIT 1

Q: Maximal usage. If every caller registered with a customer makes at least one call in one day then that customer 
has "maximal usage" of the service. List the maximal customers for 2017-08-13.

WITH caller_count_cte AS 
(
SELECT company_name, COUNT(DISTINCT Issue.caller_id) AS caller_count
FROM Customer
JOIN Caller ON Customer.company_ref = Caller.company_ref 
JOIN Issue ON Caller.caller_id = Issue.caller_id 
WHERE DATE_FORMAT(call_date, '%Y-%m-%d') LIKE "2017-08-13"
GROUP BY company_name
)
SELECT Customer.company_name, caller_count, COUNT(DISTINCT Caller.caller_id) AS registered_callers
FROM Customer
JOIN Caller ON Customer.company_ref = Caller.company_ref
JOIN caller_count_cte ON Customer.company_name = caller_count_cte.company_name
GROUP BY company_name, caller_count
HAVING caller_count = registered_callers
